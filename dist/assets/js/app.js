!function(){"use strict";function t(){1.6<window.innerHeight/window.innerWidth?(document.body.classList.add("vertical"),document.body.classList.remove("horizontal")):(document.body.classList.add("horizontal"),document.body.classList.remove("vertical"))}var e=class{constructor(){this.questions=[],this.usedIndexes=new Set}async loadQuestions(){if(!this.questions.length)try{var t=await fetch("./assets/js/questions.json");if(!t.ok)throw new Error("Ошибка загрузки questions.json");this.questions=await t.json()}catch(t){console.error("Ошибка при загрузке вопросов:",t)}}async getRandomQuestion(){if(await this.loadQuestions(),this.usedIndexes.size>=this.questions.length)return console.warn("Все вопросы использованы!"),null;let t;for(;t=Math.floor(Math.random()*this.questions.length),this.usedIndexes.has(t););return this.usedIndexes.add(t),this.questions[t]}resetUsedIndexes(){this.usedIndexes.clear()}},s=class{constructor(){this.token="user_token",this.name="User",this.answers=[],this.scope=50}saveResult(t){this.scope+=t.points,this.answers.push(t.points),console.log("данные сохранены"+this.scope)}getScore(){return this.scope}getName(){return this.name}sendResultToServer(t){console.log("Отправка на сервер",t)}},i=class{constructor(){this.roundEl=document.querySelector("#rounds"),this.roundStatus=this.roundEl.querySelector(".round_status span"),this.roundTarget=this.roundEl.querySelector(".round_target"),this.counterContainer=this.roundEl.querySelector(".round_container"),this.roundInfo=this.roundEl.querySelector(".round_info"),this.roundCoinInfo=this.roundEl.querySelector(".round_coin_info"),this.roundResult=this.roundEl.querySelector(".round_result"),this.roundResultTotal=this.roundEl.querySelector(".round_reult_text"),this.roundFinish=this.roundEl.querySelector(".round_finish")}prepareSectionForRound(){this.roundTarget.classList.contains("winner")&&this.roundTarget.classList.remove("winner"),this.hideElement([this.roundCoinInfo,this.roundResult,this.roundResultTotal,this.roundFinish]),this.showElement([this.roundStatus,this.roundTarget,this.counterContainer,this.roundInfo])}hideElement(t){t.forEach(t=>{t.classList.add("slide-hidden"),setTimeout(()=>{t.classList.add("none")},this.animationTime)})}showElement(t){t.forEach(t=>{t.classList.remove("none"),setTimeout(()=>{t.classList.remove("slide-hidden")},10)})}waitForKeyPress(){return new Promise(s=>{document.addEventListener("keydown",function t(e){"Enter"!==e.code&&"Space"!==e.code||(document.removeEventListener("keydown",t),s())})})}waitForClick(){return new Promise(t=>{const e=()=>{document.removeEventListener("keydown",e),document.removeEventListener("mousedown",e),t()};document.addEventListener("keydown",e),document.addEventListener("mousedown",e)})}updateCounter(t){this.counterContainer.innerHTML=t.map((t,e,s)=>`
            <div class="digit-container">
                ${t.alfabet[t.current]}
                <div class="shadow ${e===s.length-1?"green":"grey"}"></div>
            </div>
        `).join("")}async showTooManyFails(){this.roundEl.classList.add("default"),this.roundTarget.innerHTML="Увы, но даже <br> Леонид Агутин <br> быстрее, чем ты...",this.roundResultTotal.innerHTML="<p>Приходи позже и попробуй <br> еще раз!</p>",this.hideElement([this.roundStatus.parentElement,this.roundCoinInfo,this.counterContainer,this.roundResult,this.roundInfo]),await this.delay(500),this.showElement([this.roundFinish,this.roundResultTotal]),await this.delay(5e3),location.reload()}showSection(t,e,s=""){""!==s&&(document.querySelector("[data-name]").textContent=s);const i=document.getElementById(t),n=(i.classList.remove("active"),setTimeout(()=>i.classList.add("none"),300),document.getElementById(e));n.classList.remove("none"),setTimeout(()=>n.classList.add("active"),10)}async runBacktimer(){const e=document.querySelector("[data-count]"),t=document.querySelector("[data-text]");for(let t=3;0<t;t--)e.querySelector(`[data-num="${t}"]`).classList.add("active"),await this.delay(1e3),e.querySelector(`[data-num="${t}"]`).classList.add("slide");setTimeout(()=>{t.classList.add("active")},300),await this.delay(1e3),t.classList.add("scale"),setTimeout(()=>{t.classList.remove("active")},300),await this.delay(1e3)}delay(e){return new Promise(t=>setTimeout(t,e))}showRound(t,n,e){this.roundEl.classList.remove("none"),this.roundStatus.textContent=t,this.roundStatus.closest(".round_status").style.display="block",this.roundTarget.style.display="block",this.roundInfo.style.display="block";t=n.map(t=>t.alfabet[t.target]).join("");this.roundTarget.innerHTML="ПОЙМАЙ "+t,this.roundInfo.innerHTML=e,this.counterContainer.innerHTML="",this.counterContainer.style.display="flex",n.forEach((t,e)=>{var s=document.createElement("div"),i=(s.classList.add("digit-container"),"number"==typeof t.current?t.current:0),t=(s.textContent=t.alfabet[i]??"?",document.createElement("div"));t.classList.add("shadow"),t.classList.add(e===n.length-1?"green":"grey"),s.appendChild(t),this.counterContainer.appendChild(s)})}async showblick(t){t=document.querySelector(t);t.classList.remove("hide"),t.classList.add("blick"),await this.delay(5e3),t.classList.remove("blick"),t.classList.add("hide")}async showSuccess(t){this.changecolor("green"),this.roundEl.classList.add("right"),this.roundEl.classList.remove("default"),setTimeout(()=>{this.showSalut()},2e3),await this.showblick(".victory"),this.hideElement([this.counterContainer,this.roundInfo]),this.showElement([this.roundCoinInfo,this.roundResult]),this.roundTarget.classList.add("winner"),this.roundTarget.innerHTML="Победа! <br> Ты заработал",this.roundCoinInfo.querySelector("span").textContent=t.points;for(let t=3;0<t;t--)this.roundResult.querySelector("span").textContent=t,await this.delay(1e3);this.roundEl.classList.add("default"),this.roundEl.classList.remove("right")}async showFail(t){this.changecolor("red"),this.roundEl.classList.add("wrong"),this.roundEl.classList.remove("default"),await this.showblick(".fail"),this.hideElement([this.counterContainer,this.roundInfo]),this.showElement([this.roundResult]),this.roundTarget.classList.add("winner"),3===t.round?(this.roundTarget.innerHTML="Ты ошибся! <br> Раундов <br> больше нет",this.roundResult.innerHTML="Общий результат через <span>3</span>"):this.roundTarget.innerHTML="Ты ошибся! <br> Попробуй <br> еще раз";for(let t=3;0<t;t--)this.roundResult.querySelector("span").textContent=t,await this.delay(1e3);this.roundEl.classList.add("default"),this.roundEl.classList.remove("wrong")}showSalut(){return new Promise(e=>{var s=["Coin.svg","Silver.svg","Gold.svg"],i=document.getElementById("coin-fireworks");if(!i)return e();let n=0;for(let t=0;t<100;t++){const a=document.createElement("img");a.src="./assets/images/salut/"+s[Math.floor(Math.random()*s.length)],a.classList.add("coin-piece");var o=Math.random()*window.innerWidth,r=1e3*Math.random();a.style.left=o+"px",a.style.top="-50px",a.style.animationDelay=r+"ms",i.appendChild(a),setTimeout(()=>{a.remove(),100===++n&&e()},2500+r)}})}changecolor(e){this.counterContainer.querySelectorAll(".shadow").forEach(t=>{(t.classList.contains("grey")||t.classList.contains("green"))&&(t.classList.remove("grey"),t.classList.remove("green"),t.classList.add(e))})}async showEnd(t){this.roundEl.classList.add("default"),this.roundTarget.innerHTML="Игра закончилась, <br> всего ты заработал",this.roundCoinInfo.querySelector("span").textContent=t,this.hideElement([this.roundStatus.parentElement,this.counterContainer,this.roundResult,this.roundInfo]),await this.delay(500),this.showElement([this.roundCoinInfo,this.roundResultTotal,this.roundFinish]),await this.delay(5e3),location.reload()}};new class{constructor(){this.round=0,this.maxRounds=3,this.failedAttempts=0,this.maxFails=3,this.started=!1,this.player=new s,this.ui=new i,this.data=new e,this.init()}async init(){await this.ui.waitForKeyPress(),this.ui.showSection("start","hello",this.player.getName()),await this.ui.waitForKeyPress(),this.ui.showSection("hello","backtimer"),await this.ui.runBacktimer(),this.ui.showSection("backtimer","rounds"),this.startGame()}async startGame(){await this.data.loadQuestions(),this.startNextRound()}async startNextRound(){await this.ui.prepareSectionForRound();var t,e=await this.data.getRandomQuestion();e?(this.currentQuestion=structuredClone(e),this.round++,this.ui.showRound(this.round,e.counter,e.fact),this.counterValues=e.counter,this.startCounter(),e=this.ui.waitForClick(),t=new Promise(t=>setTimeout(()=>t("timeout"),3e4)),e=await Promise.race([e,t]),this.stopCounter(),"timeout"===e?(console.warn("⏰ Время ожидания истекло"),this.handleFail(!0)):this.checkText()?this.handleSuccess():this.handleFail(!1)):alert("вопрос отсутствует")}startCounter(){this.started=!0,this.doCycle()}async stopCounter(){this.started=!1;var t=this.checkText(),e={points:t?300:0,success:t,round:this.round};this.player.saveResult(e),this.player.sendResultToServer?.(e),t?(this.failedAttempts=0,await this.ui.showSuccess(e)):(this.failedAttempts++,await this.ui.showFail(e)),this.failedAttempts>=this.maxFails&&this.ui.showTooManyFails()}async handleSuccess(){var t={points:300,success:!0,round:this.round};this.failedAttempts=0,await this.ui.showSuccess(t),this.round>=this.maxRounds?this.ui.showEnd(this.player.getScore()):this.startNextRound()}async handleFail(t=!1){t={points:0,success:!1,round:this.round,timeout:t};await this.ui.showFail(t),this.ui.prepareSectionForRound(),this.failedAttempts>=this.maxFails?this.ui.showTooManyFails():this.round>=this.maxRounds?this.ui.showEnd(this.player.getScore()):this.startNextRound()}doCycle(){this.started&&(this.textNext(),this.ui.updateCounter(this.counterValues),setTimeout(()=>this.doCycle(),120))}textNext(){for(let t=this.counterValues.length-1;0<=t;t--){var e=this.counterValues[t];if(e.current++,e.current<e.alfabet.length)break;e.current=0}}checkText(){return this.counterValues.every((t,e)=>t.current===t.target)}},window.addEventListener("load",t),window.addEventListener("resize",t)}();